---
title: "第２章: 統計的因果推論の基礎"
---
# Chapter２　統計的因果推論の基礎

## 2.1 導入

- **実質科学**(substantial science)
    - 因果関係を明らかにすること
        - この薬を飲むと、あの病気が治るのか
        - 「チョコレートをもっと食べると、ノーベル賞が増えるのか」
- **方法論**(methodology)
    - 実質科学の目的を達成するための方法そのもの
        - 統計学
        - 機械学習
    - 統計的因果推論は因果関係についてデータから推測するための方法論である
        - 何かを変化させた時に、他のものが変化すれば因果関係にあると言える

## 2.2 反事実モデルによる因果の定義

**反事実モデル**(counterfactual model)という考え

### 2.2.1 個体レベルの因果

**個体レベルの因果**(unit-level causation)とは

1. 例による説明

    個体Aがある病気にかかっているとし、我々はある薬が個体Aを治すか否かに興味がある

    - 調べるためには以下の行動の比較ができれば良い
        - 個体Aに薬を飲んでもらう
        - 個体Aに薬を飲まないでもらう
    - 結果としてはざっくり以下のようなケースがある
        - 飲んでもらった場合に病気が治り、飲まないでもらった場合病気が治らない
            - 個体Aにおいて、薬を飲むかどうかが病気が治るかどうかの原因となる
        - 飲んでもらった場合にもそうでない場合でも病気が治らない
            - 個体Aにおいて、薬を飲むかどうかが病気が治るかどうかの原因とはならない
2. 記号による説明

    記号を以下のように定義すると、上記で説明された例を数理的枠組みに落とし込むことが可能

    - $x:$  薬を飲むかどうか
        - $x = 0$ ならば薬を飲まない
        - $x = 1$ ならば薬を飲む
    - $y:$  ３日後に病気にかかっているかどうか
        - $y = 0$ ならば３日後に病気にかかっていない
        - $y = 1$ ならば３日後に病気にかかっている

### 2.2.2 因果推論の根本的問題

上記のように因果を調べようとすると、大きな問題が１つ生じる

- ２つの行動の結果を両方とも観測することが不可能であること
    - すなわち、一旦「個体Aに薬を飲んでもらう場合」を観測すると、「個体Aに薬を飲まないでもらう場合」を観測することが不可能となってしまう
    - これを**因果推論の根本問題**(fundamental problem of causal inference)として知られている
- 個体Aに薬を飲まないでもらうという行動の結果は事実
- 個体Aに薬を飲まないでもらうという行動の結果は実際に起こらない、これを反事実と呼ぶ

### 2.2.3 集団レベルの因果

ある集団の全ての個体がある病気にかかっている場合(**集団レベルの因果**(population-level causation))を導入する

- ある薬がこの集団にかかっている病気を治すかどうかに興味がある
- 調べるためには以下の行動の比較ができれば良い
    - この集団の個体全てに薬を飲んでもらう
    - この集団の個体全てに薬を飲まないでもらう
- 個体レベルの因果と集団レベルの因果の相違点
    - 個体レベルは治るか治らないかの２択
    - 集団レベルは何割の個体が治るかという集団としての振る舞いに着目している

記号による表現を考える

- 基本は2.2.1節に従って表現することにする
    - 「この集団の個体全てに薬を飲んべもらう場合に、病気が治る個体の割合」

     ☞  「この集団の個体全ての $x$ の値を $1$ に定めた場合に、 $y$ の値が $0$ である個体の割合」


但し、個体レベルの因果と同様の問題が発生する

- つまり、「個体全てに薬を飲んでもらう場合」を観測してしまうと、「個体全てに薬を飲まないでもらう場合」を観測することが不可能となる

## 2.3 構造方程式モデルによるデータ生成過程の記述

変数の値が決定される手順、つまり、データ生成過程を記述する数学的な道具として、**構造方程式モデル**(structual equation models)を考える

- 薬と病気の例で考える
    - 病気にかかっているかを表す変数 $y$ の値がどのように決定されるのかというデータ生成過程を、次のような方程式で表現する

        $$
        y = f_y(x, e_y)
        $$

        - $e_y:$  $y$ の値を決定するための寄与しうる $x$ 以外の全ての変数をまとめて表す誤差変数
        - この方程式を**構造方程式**(structural equation)と呼ぶ
            - 単に両辺が正しいことを表すのではなく、左辺が右辺で定義されることを表す
        - $x, y$ が観測変数で、$e_y$ は未観測変数
    - $x$ に関するデータ生成過程も同様に構造方程式を用いて表すと、以下の通り

        $$
        x = f_x(\bar{e}_x)
        $$

        - もちろん上記の表現でも良いが、$x$ は誤差変数 $\bar{e}_x$ のみに決定付けられるので以下のように書き換えることも可能

    $$
    x = e_x
    $$

- 上記のような構造方程式モデルが表すデータ生成過程
    1. 初めに、$e_x, e_y$ が決定される
    2. $e_x$ により $x$ の値が決定される
    3. 最後に、$x, e_y$ により $y$ の値が決定される

上記の構造方程式に対応する因果グラフは以下の通り

![](/images/casual-discovery-20231016/chapter2-1.png)

- このように、$e_x, e_y$間は必ずしも独立とは限らない
- また、変数$x, y$は**内生変数**(endogenous variable)と呼ばれ、$e_x, e_y$は**外生変数**(exogenous variable)と呼ばれる
    - 外生変数は構造方程式の右辺にのみ登場する変数であり、どのような手順で生成されるかは記述されない

一般的に構造方程式モデルは以下の４つ組みとして定義される

1. 内生変数
2. 外生変数
3. 内生変数と外生変数をつなぐ関数
4. 外生変数の確率分布
- また、構造方程式モデルが表す変数の値の定性的な決定権系を**因果グラフ**を用いて表現する

構造方程式モデルは観測変数の$x, y$の確率分布$p(x, y)$に基づいて構造方程式モデルに関する推測を行う

これを、一般的な構造方程式モデルで言い換えると以下のようになる

$$
v_i = f_i(\bm{v}, \bm{u})
$$

- $\bm{v} = [v_1, ..., v_p]^\top:$  $p$ 個の内生変数
- $u = [u_1, ..., u_q]^\top:$  $q$ 個の外生変数
- $f_i:$  $i$ 番目の内生変数 $v_i$ のための構造方程式
- 構造方程式モデルないんで生成される内生変数の確率分布 $p(\bm{v})$ は、モデル街で生成される外生変数の確率分布 $p(\bm{u})$ と、内生変数と外生変数をつなぐ関数 $\bm{f}$ によって決まる
- 構造方程式モデルは、内生変数の内観測できる変数 $\bm{o}$ の確率分布 $p(\bm{o})$ から統計的推測を行う

## 2.4 統計的因果推論の枠組み：構造的因果モデル

因果推論のための代表的な枠組みである**構造的因果モデル**(structural causal model)は以下の２つのモデルを基礎としている

- 反事実モデル
- 構造方程式モデル

### 2.4.1 集団レベルの因果表現

以下では、反事実モデルで定義される因果関係を、構造方程式モデルを用いて数学的に表現する

- **介入**(intervention)とは
    - ある変数 $x$ に介入するとは、「他のどの変数がどんな値を取ろうとも、変数 $x$ の値を定数 $c$ にとる」ことを意味する
        - このような介入を $\text{do}(x=c)$ と表現する
        - 介入自体はモデルの外から行う
        - どの変数をモデルに含めるのかは分析者が判断する
    - 構造方程式モデルにおいて、介入とは「$x$ のデータ生成過程を表す構造方程式を、別のデータ生成過程を表す構造方程式である $x=c$ と取り替える」ことに相当する
    - 取り替えた結果、以下のような新たな構造方程式モデルが完成する

        $$
        \begin{align*}
        x &= c \\
        y &= f_y(x, e_y)
        \end{align*}
        $$

        - この構造方程式モデルを$M_{x=c}$と表現する
        - $x$ の値は $c$ と定められており、これは他のどの変数によっても決定しない
            - $c, e_y$間は独立である
            - 但し、「構造方程式のどれを入れ替えても、それ以外の構造法て式の関数や外生変数の分布は変わらない」という**自律性の仮定**(autonomy assumption)を前提としている
    - また、$x$ への介入後の $y$ の確率分布 $p(y|\text{do}(x=c))$は以下のように定義可能である

        $$
        p(y|\text{do}(x=c)) \coloneqq p_{M_{x=c}}(y)
        $$

        - つまり、$x$ の値を $c$ に定めるという介入をした後の $y$ の分布は、介入によって生成された新たな構造方程式モデル $M_{x=c}$ における $y$ の分布で定義される
- 介入を踏まえて集団レベルの因果を構造方程式モデルで表現する
    - もし介入後の $y$ の確率分布が異なるような $x$ の値 $c, d$ があれば、「この集団において、$x$ は $y$ の原因となる」という
    - 数式化すると以下の通り

        $$
        p(y|\text{do}(x=c)) \neq p(y|\text{do}(x=d))
        $$


### 2.4.2 因果効果の大きさの定量化

もし因果関係にあることが発覚した時、次に興味があるのがどの程度の大きさなのかである

- 変数 $x$ から変数 $y$ への因果効果の大きさを定量化する一般的な方法は、次のように平均的な差を評価することである

    $$
    E(y|\text{do}(x=d)) - E(y|\text{do}(x=c))
    $$

    - この量は、**平均因果効果**(average causal effect)と呼ぶ
    - 因果効果の大きさを知りたい場合は、相関係数でなく平均因果効果を計算する
- 以下のような $x, y$ のデータ生成過程を表す構造方程式モデルをを考える。但し、関数 $f_y$ は線形であると仮定する

    $$
    \begin{align*}
    x &= e_x \\
    y &= b_{yx}x + e_y
    \end{align*}
    $$

    このモデルに対して $x$ から $y$ への平均因果効果は以下のように計算可能である

    $$
    \begin{align*}
    E(y|\text{do}(x=d)) - E(y|\text{do}(x=c)) &= E(b_{yx}d + e_y) - E(b_{yx}c + e_y) \\
    &= b_{yx}(d-c)
    \end{align*}
    $$

    一方、このモデルに対して $y$ から $x$ への平均因果効果は以下のように計算可能である

    $$
    \begin{align*}
    E(x|\text{do}(y=d)) - E(x|\text{do}(y=c)) &= E(e_x) - E(e_x) \\
    &= 0
    \end{align*}
    $$


### 2.4.3 個体レベルの因果の表現

構造方程式モデルは、個体レベルの因果を表現するためにも使うことが可能

- 薬と病気の例で説明する
    - 「個体Aに薬を飲んでもらった場合に（介入して $x$ の値を１にする）、３日後病気にかかっているかどうか」を $y_{x=1}^{(A)}$ で表す
        - 右上は対象の個体を指している
        - 右下は介入した $x$ の値を指している
    - 誤差変数 $e_x, e_y$ は「薬を飲むかどうか」及び「３日後に病気にかかっているかどうか」以外を表している変数であり、個体差はここに生じる
        - 個体Aの誤差変数を $e_x^{(A)}, e_y^{(A)}$ とする
        - すると、$y_{x=1} = f_y(e_x^{(A)}, e_y^{(A)})$ と書ける
    - $x$ の値を１に定めた場合の構造方程式モデル $M_{x=1}$ を考える
        - これらを数式で書くと以下のようになる

            $$
            \begin{align*}
            y_{x=0}^{(A)} = f_y(0, e_y^{(A)}) \\
            y_{x=1}^{(A)} = f_y(1, e_y^{(A)})
            \end{align*}
            $$

    - 個体レベルの因果を構造方程式モデルで書く
        - 以下の条件を満たした時、「個体Aにおいて、薬を飲むかどうかが病気が治すかどうかの原因となる」と言える

            $$
            y_{x=0}^{(A)} \neq y_{x=1}^{(A)}
            $$


### 2.4.4 出来事の説明

因果というのは「もし介入した場合にどうなるか」という表現をしている

構造的因果モデルは、このような予測だけでなく「過去に起きた出来事の原因がなんだったか」という説明も表現できる

- 以下のような大学生の個体Bを考える
    - 試験勉強をせず期末試験を受けたところ、得点が50点だった

    この個体Bに試験勉強をしてもらって、期末試験をしてもらったら、いったい何点を取るのか？という予測を行いたい

    - 勉強をした結果70点だったとすれば、50点だった原因として試験勉強をしなかったことが妥当であると言える
    - 勉強をした結果50点だったとすれば、50点だった原因として試験勉強をしなかったことが妥当ではないと言える

    これを、以下のような構造的因果モデルの枠組みで考える

    - 試験勉強をするかどうかを $x$ で書く
    - 期末試験の結果を $y$ で書く
    - これを実際の数式で書くと以下の通り

        $$
        \begin{align*}
        x &= e_x \\
        y &= 20x + e_y
        \end{align*}
        $$

        🧐 恐らく $20$ の部分は適当に分析者が決めた数字

        🧐 因果があるという前提の数式となっている

        - 実際の結果として、$x^{(B)} = 0$ の時 $y^{(B)} = 50$ と書ける
        - ここから、$e_y$  の値が $50$  であることがわかる
    - 個体Bが勉強をしたケースは実際には観測できない反事実であることに注意
- 集団についての反事実を考えることも可能
    - $y$ を合否を表すとする
    - もしも試験勉強をしてもらっていたら合格していたであろう確率を $p(y_{x=1}=1|x=0, y=0)$ と表現する
        - $y_{x=1}$ はもしも $x$ に介入し、その値を $1$ と定めたときの $y$ の値
        - すなわち、勉強せずに（$x=0$）不合格だった（$y=0$）人が、もしも勉強をしていたら合格していたであろう（$y_{x=1}=1$）確率、と解釈可能
    - このような反事実的な量について、さらに考察するためには、構造的因果モデルだけでなく、**潜在反応モデル**(potential outcome model)と呼ばれる統計的因果推論の枠組みが役に立つ

## 2.5 ランダム化実験

今までは、因果に関する概念とその数学的表現を紹介してきた

この説では、因果関係を推測する上で、最もシンプルに分析が可能な**ランダム化実験**(randomized experiment)（無作為化実験）を構造的因果モデルの枠組みで紹介する

- 薬と病気の例で紹介する
    - 今回では、それぞれの個体が薬を飲むかどうか（$x$ の値）をランダムに決定する
        - こうすると、薬を飲むかどうかが他のどの変数とも独立に決定することが可能
        - ここで、薬を飲むかどうか（$x$）は、病気にかかっているかどうか（$y$）を調べるより、時間的に先行しているため、３日後に病気にかかっているかどうかが、薬を飲むかどうかの原因となりうることはない、という事前知識がある
    - このような構造方程式は以下のように書ける

        $$
        \begin{align*}
        x &= \tilde{e}_x \\
        y &= f_y(x, e_y)
        \end{align*}
        $$

        - $\tilde{e}_x:$  成功確率 $1/2$ のベルヌーイ分布に従う確率変数
        - $\tilde{e}_x$ は完全にランダムで決定されるため、$x$ 及び $y$ を両方の値を部分的にでも決めるような共通原因がない
    - 続いて、「薬を飲んでもらうと、３日後に病気にかかっている個体の数が平均的にどの程度変化するか」という平均因果効果を推定する
    - 2.4.2節で説明した式に基づいて考えるために、介入後の構造方程式モデル $M_{x=c}$ を考慮すると、以下のように平均因果効果は与えられる

        $$
        \begin{align*}
        &~E(y|\text{do}(x=1)) - E(y|\text{do}(x=0)) \\
         = &~E(f_y(1, e_y)) - E(f_y(0, e_y))
        \end{align*}
        $$

    - 一方、ランダム化実験の構造方程式モデルにおける $\text{do}$ 記号のない通常の条件付き期待値の差は以下の通り

        $$
        \begin{align*}
        &~E(y|x=1) - E(y|x=0) \\
         = &~E(f_y(1, e_y)|x=1) - E(f_y(0, e_y)|x=0)
        \end{align*}
        $$

         🧐  $x$ に介入をしないため、ただ $\text{do}$ がついていないはず

        - ここで、上記に示した構造方程式より $x = \tilde{e}_x$ であることがわかっているので

        $$
        p(e_y|x) = p(e_y|\tilde{e}_x)
        $$

        と書き直せる

        - さらに、独立性より

        $$
        p(e_y|\tilde{e}_x) = p(e_y)
        $$

        と書ける

        - もし、未観測”共通”原因が存在する、すなわち、$e_x$ と $e_y$ が従属の関係であれば、上記の式は成立しない

         🧐  今回は $e_x$ をランダムに決めているため独立である

         🧐  これがランダム化実験の強み（なはず）

        - これらより以下の等式が成立する

        $$
        p(e_y|x) = p(e_y)
        $$

        - ゆえに、ランダム化実験の構造方程式モデルにおける $\text{do}$ 記号のない通常の条件付き期待値の差は以下のように式変形が可能

        $$
        \begin{align*}
        &~E(y|x=1) - E(y|x=0) \\
         = &~E(f_y(1, e_y)|x=1) - E(f_y(0, e_y)|x=0) \\
         = &~E(f_y(1, e_y)) - E(f_y(0, e_y))
        \end{align*}
        $$

    - これまでの話を総合すると

        $$
        E(y|\text{do}(x=1)) - E(y|\text{do}(x=0)) = E(y|x=1) - E(y|x=0)
        $$

        が成立することがわかる

        - 要するに、$\text{do}$ 記号の入った平均因果効果が、右辺の $\text{do}$ 記号の入っていない平均因果効果通常の条件付き期待値の差で書けることが示された
            - $\text{do}$ 記号込みの期待値を計算するためには、集団の個体を全ての $x$ の値を $1$ または $0$ に定める必要がある
                - これは、  因果推論の根本問題により、片方を観察した段階でもう片方の観察が不可能になってしまう
            - $\text{do}$ 記号の入っていない通常の条件付き期待値の計算のためには、そのような集団の個体全てへ同一の介入をする必要がない
- ランダム化実験では、より一般的に、$\text{do}$ 記号の入った介入後の分布は、$\text{do}$ 記号の入っていない通常の条件付き分布と等価になる

    $$
    p(y|\text{do}(x=c)) = p(y|x=c)
    $$

    - 誤差変数 $\tilde{e}_x$ と $e_y$ が独立であるため

## 2.6 まとめ

- 統計的因果推論の代表的な枠組みである**構造的因果モデル**の解説をした
- **介入**に基づいて定義される因果関係を数式的に記述するためには、確率論の言葉だけでは不足しているということが重要
    - $\text{do}$ を導入
- 因果効果の大きさを測るためには、相関係数ではなく、**平均因果効果**が必須
- 平均因果効果の推定法の一つとして、**ランダム化実験**が挙げられる
    1. 時間方向の事前知識により、双方向の因果の可能性を削除
    2. ランダム化により、誤差変数の独立性を担保することによって、$\text{do}$ 記号入りの期待値を通常の条件付き期待値によって計算できるようにする
        - 但し、ランダム化実験を行うことは一般的に困難である
